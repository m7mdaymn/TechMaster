import{a as q}from"./chunk-ZAODAAZN.js";import{b as G,d as J,g as K,t as X}from"./chunk-HRUO5R4Q.js";import{a as H}from"./chunk-UYI4POZX.js";import{a as Y}from"./chunk-JLLNXAHD.js";import{a as B}from"./chunk-SAC5YDHM.js";import"./chunk-AJDLSE77.js";import{a as Q,d as W}from"./chunk-L2ZR2CCC.js";import{$a as b,Ab as c,Bb as u,Cb as E,Fb as D,Gb as T,Hb as I,Ja as w,Jb as F,Na as l,Q as U,W as h,Wa as g,Y as z,a as A,b as L,cb as O,eb as y,ga as _,gb as x,ha as C,jb as S,kb as R,lb as o,mb as a,mc as N,nb as M,qb as k,r as f,sb as v,tb as p,vb as j,wb as $,xb as V}from"./chunk-Q5RFH5SI.js";var Z=(()=>{class i{http=h(W);API_URL=`${Y.apiUrl}/chat`;activeRoom=g(null);rooms=g([]);messages=g([]);totalUnread=g(0);getRooms(){return this.http.get(`${this.API_URL}/rooms`).pipe(f(e=>e.data||[]))}getRoom(e){return this.http.get(`${this.API_URL}/rooms/${e}`).pipe(f(t=>t.data))}joinRoom(e){return this.http.post(`${this.API_URL}/rooms/${e}/join`,{})}leaveRoom(e){return this.http.post(`${this.API_URL}/rooms/${e}/leave`,{})}getMessages(e,t=1,n=50){let s=new Q().set("pageNumber",t.toString()).set("pageSize",n.toString());return this.http.get(`${this.API_URL}/rooms/${e}/messages`,{params:s}).pipe(f(r=>r.data))}sendMessage(e,t){return this.http.post(`${this.API_URL}/rooms/${e}/messages`,t).pipe(f(n=>n.data))}markRoomAsRead(e){return this.http.post(`${this.API_URL}/rooms/${e}/read`,{})}createCourseRoom(e){return this.http.post(`${this.API_URL}/rooms/course`,{courseId:e}).pipe(f(t=>t.data))}refreshRooms(){this.getRooms().subscribe({next:e=>{this.rooms.set(e),this.totalUnread.set(e.reduce((t,n)=>t+(n.unreadCount||0),0))},error:()=>{}})}static \u0275fac=function(t){return new(t||i)};static \u0275prov=U({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();var ne=["messagesContainer"],ee=(i,m)=>m.id;function ie(i,m){i&1&&M(0,"span",16)}function oe(i,m){if(i&1&&(o(0,"span",23),c(1),a()),i&2){let e=p().$implicit;l(),u(e.unreadCount)}}function ae(i,m){if(i&1){let e=k();o(0,"div",13),v("click",function(){let n=_(e).$implicit,s=p();return C(s.selectRoom(n))}),o(1,"div",14),M(2,"img",15),b(3,ie,1,0,"span",16),a(),o(4,"div",17)(5,"div",18)(6,"span",19),c(7),a(),o(8,"span",20),c(9),a()(),o(10,"div",21)(11,"span",22),c(12),a(),b(13,oe,2,1,"span",23),a()()()}if(i&2){let e,t=m.$implicit,n=p();y("active",((e=n.selectedRoom())==null?null:e.id)===t.id),l(2),O("src",t.avatar||"assets/images/default-avatar.png",w)("alt",t.name),l(),x(t.isOnline?3:-1),l(4),u(t.name),l(2),u(n.formatTime(t.lastMessageTime)),l(3),u(t.lastMessage),l(),x(t.unreadCount>0?13:-1)}}function re(i,m){i&1&&(o(0,"div",10)(1,"p"),c(2,"No conversations yet"),a()())}function se(i,m){i&1&&M(0,"span",16)}function ce(i,m){if(i&1&&M(0,"img",41),i&2){let e=p().$implicit;O("src",e.senderAvatar||"assets/images/default-avatar.png",w)("alt",e.senderName)}}function le(i,m){if(i&1&&(o(0,"div",40),b(1,ce,1,2,"img",41),o(2,"div",42)(3,"div",43),c(4),a(),o(5,"span",44),c(6),a()()()),i&2){let e=m.$implicit,t=p(2);y("own",e.isOwn),l(),x(e.isOwn?-1:1),l(3),E(" ",e.content," "),l(2),u(t.formatMessageTime(e.timestamp))}}function de(i,m){if(i&1){let e=k();o(0,"div",18)(1,"button",24),v("click",function(){_(e);let n=p();return C(n.showSidebar.set(!0))}),o(2,"span"),c(3,"\u2190"),a()(),o(4,"div",25)(5,"div",14),M(6,"img",15),b(7,se,1,0,"span",16),a(),o(8,"div",26)(9,"h3"),c(10),a(),o(11,"span",27),c(12),a()()(),o(13,"div",28)(14,"button",29),c(15,"\u{1F4F9}"),a(),o(16,"button",30),c(17,"\u{1F4DE}"),a(),o(18,"button",31),c(19,"\u22EE"),a()()(),o(20,"div",32,0),S(22,le,7,5,"div",33,ee),a(),o(24,"div",34)(25,"button",35),c(26,"\u{1F4CE}"),a(),o(27,"div",36)(28,"input",37),I("ngModelChange",function(n){_(e);let s=p();return T(s.newMessage,n)||(s.newMessage=n),C(n)}),v("keydown.enter",function(){_(e);let n=p();return C(n.sendMessage())}),a(),o(29,"button",38),c(30,"\u{1F60A}"),a()(),o(31,"button",39),v("click",function(){_(e);let n=p();return C(n.sendMessage())}),o(32,"span"),c(33,"\u27A4"),a()()()}if(i&2){let e,t,n,s,r,d=p();l(6),O("src",((e=d.selectedRoom())==null?null:e.avatar)||"assets/images/default-avatar.png",w)("alt",(t=d.selectedRoom())==null?null:t.name),l(),x((n=d.selectedRoom())!=null&&n.isOnline?7:-1),l(3),u((s=d.selectedRoom())==null?null:s.name),l(2),E(" ",(r=d.selectedRoom())!=null&&r.isOnline?"Online":"Offline"," "),l(10),R(d.messages()),l(6),D("ngModel",d.newMessage),l(3),O("disabled",!d.newMessage.trim())}}function me(i,m){i&1&&(o(0,"div",12)(1,"div",45),c(2,"\u{1F4AC}"),a(),o(3,"h3"),c(4,"Select a Conversation"),a(),o(5,"p"),c(6,"Choose a conversation from the sidebar to start chatting"),a()())}var Re=(()=>{class i{messagesContainer;authService=h(q);chatService=h(Z);mediaService=h(H);route=h(B);searchQuery="";newMessage="";showSidebar=g(!1);isLoading=g(!1);rooms=g([]);selectedRoom=g(null);messages=g([]);shouldScroll=!1;ngOnInit(){this.loadRooms(),this.route.queryParams.subscribe(e=>{e.instructorId&&this.startChatWithInstructor(e.instructorId,e.courseId,e.courseName)})}startChatWithInstructor(e,t,n){let s=this.rooms().find(r=>r.id.includes(e)||t&&r.id.includes(t));s?this.selectRoom(s):t&&this.chatService.createCourseRoom(t).subscribe({next:r=>{if(r){let d={id:r.id,name:n||r.name||"Instructor Chat",avatar:"assets/images/default-avatar.png",lastMessage:"",lastMessageTime:new Date,unreadCount:0,isOnline:!1,type:"course"};this.rooms.update(P=>[d,...P]),this.selectRoom(d)}},error:()=>{this.loadRooms()}})}ngAfterViewChecked(){this.shouldScroll&&(this.scrollToBottom(),this.shouldScroll=!1)}loadRooms(){this.isLoading.set(!0),this.chatService.getRooms().subscribe({next:e=>{let t=e.map(n=>({id:n.id,name:n.name||n.courseName||"Chat Room",avatar:"assets/images/default-avatar.png",lastMessage:n.lastMessage||"",lastMessageTime:n.lastMessageAt?new Date(n.lastMessageAt):new Date,unreadCount:n.unreadCount||0,isOnline:!1,type:n.type?.toLowerCase()||"course"}));this.rooms.set(t),this.isLoading.set(!1)},error:()=>{this.isLoading.set(!1),this.rooms.set([])}})}filteredRooms(){if(!this.searchQuery.trim())return this.rooms();let e=this.searchQuery.toLowerCase();return this.rooms().filter(t=>t.name.toLowerCase().includes(e)||t.lastMessage.toLowerCase().includes(e))}selectRoom(e){this.selectedRoom.set(e),this.showSidebar.set(!1),e.unreadCount=0,this.loadMessages(e.id),this.chatService.markRoomAsRead(e.id).subscribe()}loadMessages(e){let t=this.authService.getCurrentUser();this.chatService.getMessages(e).subscribe({next:n=>{let s=(n.items||[]).map(r=>({id:r.id,senderId:r.senderId,senderName:r.senderName,senderAvatar:this.mediaService.getAvatarUrl(r.senderAvatar),content:r.content,timestamp:new Date(r.createdAt),isOwn:r.senderId===t?.id}));this.messages.set(s),this.shouldScroll=!0},error:()=>{this.messages.set([])}})}sendMessage(){if(!this.newMessage.trim()||!this.selectedRoom())return;let e=this.authService.getCurrentUser(),t=this.selectedRoom().id,n=this.newMessage,s={id:"temp-"+Date.now(),senderId:e?.id||"",senderName:e?.fullName||"You",senderAvatar:this.mediaService.getAvatarUrl(e?.profileImageUrl),content:n,timestamp:new Date,isOwn:!0};this.messages.update(r=>[...r,s]),this.newMessage="",this.shouldScroll=!0,this.chatService.sendMessage(t,{content:n}).subscribe({next:r=>{this.messages.update(d=>d.map(P=>P.id===s.id?L(A({},P),{id:r.id}):P))},error:()=>{this.messages.update(r=>r.filter(d=>d.id!==s.id))}})}scrollToBottom(){if(this.messagesContainer){let e=this.messagesContainer.nativeElement;e.scrollTop=e.scrollHeight}}formatTime(e){let n=new Date().getTime()-new Date(e).getTime(),s=Math.floor(n/(1e3*60*60*24));return s===0?new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):s===1?"Yesterday":s<7?`${s}d`:new Date(e).toLocaleDateString()}formatMessageTime(e){return new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=z({type:i,selectors:[["app-chat"]],viewQuery:function(t,n){if(t&1&&j(ne,5),t&2){let s;$(s=V())&&(n.messagesContainer=s.first)}},standalone:!0,features:[F],decls:19,vars:5,consts:[["messagesContainer",""],[1,"chat-page"],[1,"chat-sidebar"],[1,"sidebar-header"],[1,"new-chat-btn"],[1,"search-box"],[1,"search-icon"],["type","text","placeholder","Search conversations...",3,"ngModelChange","ngModel"],[1,"chat-list"],[1,"chat-item",3,"active"],[1,"empty-chats"],[1,"chat-main"],[1,"no-chat-selected"],[1,"chat-item",3,"click"],[1,"avatar-wrapper"],[3,"src","alt"],[1,"online-dot"],[1,"chat-info"],[1,"chat-header"],[1,"chat-name"],[1,"chat-time"],[1,"chat-preview"],[1,"last-message"],[1,"unread-badge"],[1,"mobile-back-btn",3,"click"],[1,"chat-user"],[1,"user-info"],[1,"status"],[1,"chat-actions"],["title","Video Call",1,"action-btn"],["title","Voice Call",1,"action-btn"],["title","More",1,"action-btn"],[1,"messages-container"],[1,"message",3,"own"],[1,"message-input"],[1,"attach-btn"],[1,"input-wrapper"],["type","text","placeholder","Type a message...",3,"ngModelChange","keydown.enter","ngModel"],[1,"emoji-btn"],[1,"send-btn",3,"click","disabled"],[1,"message"],[1,"message-avatar",3,"src","alt"],[1,"message-content"],[1,"message-bubble"],[1,"message-time"],[1,"empty-icon"]],template:function(t,n){t&1&&(o(0,"div",1)(1,"aside",2)(2,"div",3)(3,"h2"),c(4,"Messages"),a(),o(5,"button",4)(6,"span"),c(7,"\u270F\uFE0F"),a()()(),o(8,"div",5)(9,"span",6),c(10,"\u{1F50D}"),a(),o(11,"input",7),I("ngModelChange",function(r){return T(n.searchQuery,r)||(n.searchQuery=r),r}),a()(),o(12,"div",8),S(13,ae,14,9,"div",9,ee,!1,re,3,0,"div",10),a()(),o(16,"main",11),b(17,de,34,7)(18,me,7,0,"div",12),a()()),t&2&&(l(),y("active",n.showSidebar()),l(10),D("ngModel",n.searchQuery),l(2),R(n.filteredRooms()),l(4),x(n.selectedRoom()?17:18))},dependencies:[N,X,G,J,K],styles:[".chat-page[_ngcontent-%COMP%]{display:grid;grid-template-columns:350px 1fr;height:calc(100vh - 70px);background:#f8f9fa}.chat-sidebar[_ngcontent-%COMP%]{background:#fff;border-right:1px solid #e0e0e0;display:flex;flex-direction:column}.sidebar-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:1.25rem;border-bottom:1px solid #e0e0e0}.sidebar-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:1.25rem;font-weight:700}.new-chat-btn[_ngcontent-%COMP%]{width:36px;height:36px;background:#247090;border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}.search-box[_ngcontent-%COMP%]{padding:1rem;position:relative}.search-icon[_ngcontent-%COMP%]{position:absolute;left:1.75rem;top:50%;transform:translateY(-50%)}.search-box[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:100%;padding:.75rem 1rem .75rem 2.75rem;border:2px solid #e0e0e0;border-radius:10px;font-size:.95rem}.search-box[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus{outline:none;border-color:#247090}.chat-list[_ngcontent-%COMP%]{flex:1;overflow-y:auto}.chat-item[_ngcontent-%COMP%]{display:flex;gap:.75rem;padding:1rem 1.25rem;cursor:pointer;transition:background .3s ease;border-bottom:1px solid #f0f0f0}.chat-item[_ngcontent-%COMP%]:hover{background:#f8f9fa}.chat-item.active[_ngcontent-%COMP%]{background:#e8f4f8}.avatar-wrapper[_ngcontent-%COMP%]{position:relative;flex-shrink:0}.chat-item[_ngcontent-%COMP%]   .avatar-wrapper[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:50px;height:50px;border-radius:50%;object-fit:cover}.online-dot[_ngcontent-%COMP%]{position:absolute;bottom:2px;right:2px;width:12px;height:12px;background:#28a745;border:2px solid #fff;border-radius:50%}.chat-info[_ngcontent-%COMP%]{flex:1;min-width:0}.chat-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;margin-bottom:.25rem}.chat-name[_ngcontent-%COMP%]{font-weight:600;color:#000}.chat-time[_ngcontent-%COMP%]{font-size:.75rem;color:#999}.chat-preview[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.last-message[_ngcontent-%COMP%]{font-size:.85rem;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px}.unread-badge[_ngcontent-%COMP%]{background:#247090;color:#fff;font-size:.7rem;font-weight:700;padding:.125rem .5rem;border-radius:10px;min-width:20px;text-align:center}.empty-chats[_ngcontent-%COMP%]{padding:2rem;text-align:center;color:#666}.chat-main[_ngcontent-%COMP%]{display:flex;flex-direction:column;background:#fff}.chat-main[_ngcontent-%COMP%]   .chat-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:1rem;padding:1rem 1.5rem;border-bottom:1px solid #e0e0e0;background:#fff}.mobile-back-btn[_ngcontent-%COMP%]{display:none;width:36px;height:36px;background:#f8f9fa;border:none;border-radius:8px;cursor:pointer;font-size:1.25rem}.chat-user[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem;flex:1}.chat-user[_ngcontent-%COMP%]   .avatar-wrapper[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:45px;height:45px;border-radius:50%;object-fit:cover}.user-info[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:1rem;font-weight:700;margin-bottom:.125rem}.user-info[_ngcontent-%COMP%]   .status[_ngcontent-%COMP%]{font-size:.8rem;color:#28a745}.chat-actions[_ngcontent-%COMP%]{display:flex;gap:.5rem}.action-btn[_ngcontent-%COMP%]{width:36px;height:36px;background:#f8f9fa;border:none;border-radius:8px;cursor:pointer;font-size:1rem;transition:all .3s ease}.action-btn[_ngcontent-%COMP%]:hover{background:#e0e0e0}.messages-container[_ngcontent-%COMP%]{flex:1;overflow-y:auto;padding:1.5rem;display:flex;flex-direction:column;gap:1rem;background:#f8f9fa}.message[_ngcontent-%COMP%]{display:flex;gap:.75rem;max-width:70%}.message.own[_ngcontent-%COMP%]{margin-left:auto;flex-direction:row-reverse}.message-avatar[_ngcontent-%COMP%]{width:36px;height:36px;border-radius:50%;object-fit:cover;flex-shrink:0}.message-content[_ngcontent-%COMP%]{display:flex;flex-direction:column}.message.own[_ngcontent-%COMP%]   .message-content[_ngcontent-%COMP%]{align-items:flex-end}.message-bubble[_ngcontent-%COMP%]{padding:.75rem 1rem;background:#fff;border-radius:4px 16px 16px;box-shadow:0 1px 2px #0000001a;line-height:1.5}.message.own[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]{background:#247090;color:#fff;border-radius:16px 4px 16px 16px}.message-time[_ngcontent-%COMP%]{font-size:.7rem;color:#999;margin-top:.25rem;padding:0 .5rem}.message-input[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem;padding:1rem 1.5rem;border-top:1px solid #e0e0e0;background:#fff}.attach-btn[_ngcontent-%COMP%]{width:40px;height:40px;background:#f8f9fa;border:none;border-radius:50%;cursor:pointer;font-size:1.1rem}.input-wrapper[_ngcontent-%COMP%]{flex:1;position:relative}.input-wrapper[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:100%;padding:.875rem 3rem .875rem 1rem;border:2px solid #e0e0e0;border-radius:25px;font-size:1rem}.input-wrapper[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus{outline:none;border-color:#247090}.emoji-btn[_ngcontent-%COMP%]{position:absolute;right:.75rem;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:1.25rem}.send-btn[_ngcontent-%COMP%]{width:45px;height:45px;background:linear-gradient(135deg,#247090,#1a5570);border:none;border-radius:50%;cursor:pointer;color:#fff;font-size:1.25rem;display:flex;align-items:center;justify-content:center;transition:all .3s ease}.send-btn[_ngcontent-%COMP%]:hover:not(:disabled){transform:scale(1.05)}.send-btn[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.no-chat-selected[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:2rem;background:#f8f9fa}.empty-icon[_ngcontent-%COMP%]{font-size:4rem;margin-bottom:1rem}.no-chat-selected[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:1.5rem;font-weight:700;margin-bottom:.5rem}.no-chat-selected[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#666}@media (max-width: 768px){.chat-page[_ngcontent-%COMP%]{grid-template-columns:1fr}.chat-sidebar[_ngcontent-%COMP%]{position:fixed;inset:70px 0 0;z-index:50;transform:translate(-100%);transition:transform .3s ease}.chat-sidebar.active[_ngcontent-%COMP%]{transform:translate(0)}.mobile-back-btn[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center}.message[_ngcontent-%COMP%]{max-width:85%}}[dir=rtl][_nghost-%COMP%]   .chat-sidebar[_ngcontent-%COMP%], [dir=rtl]   [_nghost-%COMP%]   .chat-sidebar[_ngcontent-%COMP%]{border-right:none;border-left:1px solid #e0e0e0}[dir=rtl][_nghost-%COMP%]   .search-icon[_ngcontent-%COMP%], [dir=rtl]   [_nghost-%COMP%]   .search-icon[_ngcontent-%COMP%]{left:auto;right:1.75rem}[dir=rtl][_nghost-%COMP%]   .search-box[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], [dir=rtl]   [_nghost-%COMP%]   .search-box[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{padding:.75rem 2.75rem .75rem 1rem}[dir=rtl][_nghost-%COMP%]   .message.own[_ngcontent-%COMP%], [dir=rtl]   [_nghost-%COMP%]   .message.own[_ngcontent-%COMP%]{margin-left:0;margin-right:auto}[dir=rtl][_nghost-%COMP%]   .message-bubble[_ngcontent-%COMP%], [dir=rtl]   [_nghost-%COMP%]   .message-bubble[_ngcontent-%COMP%]{border-top-left-radius:16px;border-top-right-radius:4px}[dir=rtl][_nghost-%COMP%]   .message.own[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%], [dir=rtl]   [_nghost-%COMP%]   .message.own[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]{border-top-right-radius:16px;border-top-left-radius:4px}@media (max-width: 768px){[dir=rtl][_nghost-%COMP%]   .chat-sidebar[_ngcontent-%COMP%], [dir=rtl]   [_nghost-%COMP%]   .chat-sidebar[_ngcontent-%COMP%]{transform:translate(100%)}[dir=rtl][_nghost-%COMP%]   .chat-sidebar.active[_ngcontent-%COMP%], [dir=rtl]   [_nghost-%COMP%]   .chat-sidebar.active[_ngcontent-%COMP%]{transform:translate(0)}}"]})}return i})();export{Re as ChatComponent};
