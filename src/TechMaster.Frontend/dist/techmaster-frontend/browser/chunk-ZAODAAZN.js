import{a as S}from"./chunk-JLLNXAHD.js";import{c as l}from"./chunk-SAC5YDHM.js";import{d as a}from"./chunk-L2ZR2CCC.js";import{N as s,Q as h,W as n,a as r,k as c}from"./chunk-Q5RFH5SI.js";var I=(()=>{class o{http=n(a);router=n(l);API_URL=`${S.apiUrl}/auth`;TOKEN_KEY="techmaster_token";REFRESH_TOKEN_KEY="techmaster_refresh_token";USER_KEY="techmaster_user";currentUserSubject=new c(this.loadUser());currentUser$=this.currentUserSubject.asObservable();loadUser(){let t=localStorage.getItem(this.USER_KEY);return t?JSON.parse(t):null}login(t){return this.http.post(`${this.API_URL}/login`,t).pipe(s(e=>{e.isSuccess&&e.token&&e.user&&this.setSession(e)}))}register(t){return this.http.post(`${this.API_URL}/register`,t).pipe(s(e=>{e.isSuccess&&e.token&&e.user&&this.setSession(e)}))}googleLogin(t){return this.http.post(`${this.API_URL}/google`,{idToken:t}).pipe(s(e=>{e.isSuccess&&e.token&&e.user&&this.setSession(e)}))}refreshToken(){let t=localStorage.getItem(this.REFRESH_TOKEN_KEY);return this.http.post(`${this.API_URL}/refresh-token`,{refreshToken:t}).pipe(s(e=>{e.isSuccess&&e.token&&e.user&&this.setSession(e)}))}forgotPassword(t){return this.http.post(`${this.API_URL}/forgot-password`,{email:t})}resetPassword(t,e){return this.http.post(`${this.API_URL}/reset-password`,{token:t,newPassword:e,confirmNewPassword:e})}changePassword(t,e){return this.http.post(`${this.API_URL}/change-password`,{currentPassword:t,newPassword:e,confirmNewPassword:e})}updateProfile(t){return this.http.put(`${this.API_URL}/profile`,t).pipe(s(e=>{if(e.isSuccess){let i=this.currentUserSubject.value;if(i){let u=e.user?r(r({},i),e.user):r(r({},i),t);localStorage.setItem(this.USER_KEY,JSON.stringify(u)),this.currentUserSubject.next(u)}}}))}refreshUserFromApi(){return this.http.get(`${this.API_URL}/me`).pipe(s(t=>{if(t.isSuccess&&t.data){let e=this.currentUserSubject.value;if(e){let i=r(r({},e),t.data);localStorage.setItem(this.USER_KEY,JSON.stringify(i)),this.currentUserSubject.next(i)}}}))}logout(){this.clearSession(),this.http.post(`${this.API_URL}/logout`,{}).subscribe({error:()=>{}}),this.router.navigate(["/"])}setSession(t){console.log("setSession called with:",t),console.log("Has token:",!!t.token),console.log("Has refreshToken:",!!t.refreshToken),console.log("Has user:",!!t.user),t.token&&t.refreshToken&&t.user?(localStorage.setItem(this.TOKEN_KEY,t.token),localStorage.setItem(this.REFRESH_TOKEN_KEY,t.refreshToken),localStorage.setItem(this.USER_KEY,JSON.stringify(t.user)),this.currentUserSubject.next(t.user),console.log("Session saved successfully. Token in localStorage:",!!localStorage.getItem(this.TOKEN_KEY))):console.error("Session not saved - missing required data")}clearSession(){localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.REFRESH_TOKEN_KEY),localStorage.removeItem(this.USER_KEY),this.currentUserSubject.next(null)}getToken(){return localStorage.getItem(this.TOKEN_KEY)}isAuthenticated(){return!!this.getToken()}getCurrentUser(){return this.currentUserSubject.value}isAdmin(){return this.getCurrentUser()?.role==="Admin"}isInstructor(){return this.getCurrentUser()?.role==="Instructor"}isStudent(){return this.getCurrentUser()?.role==="Student"}static \u0275fac=function(e){return new(e||o)};static \u0275prov=h({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})();export{I as a};
